import { useState, useCallback } from "react";

/**
 * 本地存储 hook
 * @param key 存储的 key
 * @param initialValue 初始值
 * @returns 返回当前值、更新函数和删除函数
 *
 * @example
 * ```tsx
 * const [user, setUser, removeUser] = useLocalStorage('user', { name: 'John' })
 *
 * <button onClick={() => setUser({ name: 'Jane' })}>Update</button>
 * <button onClick={removeUser}>Remove</button>
 * ```
 */
export function useLocalStorage<T>(key: string, initialValue: T) {
	const [storedValue, setStoredValue] = useState<T>(() => {
		try {
			const item = window.localStorage.getItem(key);
			return item ? JSON.parse(item) : initialValue;
		} catch (error) {
			console.error(`Error reading localStorage key "${key}":`, error);
			return initialValue;
		}
	});

	const setValue = useCallback(
		(value: T | ((val: T) => T)) => {
			try {
				const valueToStore =
					value instanceof Function ? value(storedValue) : value;
				setStoredValue(valueToStore);
				window.localStorage.setItem(key, JSON.stringify(valueToStore));
			} catch (error) {
				console.error(`Error setting localStorage key "${key}":`, error);
			}
		},
		[key, storedValue]
	);

	const removeValue = useCallback(() => {
		try {
			window.localStorage.removeItem(key);
			setStoredValue(initialValue);
		} catch (error) {
			console.error(`Error removing localStorage key "${key}":`, error);
		}
	}, [key, initialValue]);

	return [storedValue, setValue, removeValue] as const;
}
